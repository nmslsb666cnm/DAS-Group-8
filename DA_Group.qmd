---
title: "Data analysis"
format:
  pdf:
    documentclass: article
    fontsize: 11pt
    geometry: a4paper, margin=0.75in
execute: 
  eval: true
  echo: false
  warning: false
editor: visual
---

```{r}
library(tidyverse)
library(ggplot2)
library(tidymodels)
library(gt)
library(Matrix)
library(lme4)
library(performance)
library(broom)
library(broom.mixed)
library(pscl)
library(knitr)
library(kableExtra)
```

```{r}
#| echo: false
#| message: false
#| warning: false
library(ggplot2)
library(dplyr)
data1 <- read.csv("C:\\Users\\ASUS\\Desktop\\DAProject15.csv")
year_summary <- data1 %>%
  group_by(Year) %>%
  summarise(Y = sum(Y), N = sum(N)) %>%
  mutate(Proportion = Y / N)

```

# Formal Analysis {#sec-FA}

\(a\) We define **measles susceptibility** in each Intermediate Zone (IZ) and year as the proportion:

$$
p_i = \frac{Y_i}{N_i}
$$ where:

-   ( $Y_i$ ) is the number of susceptible pre-school children in the ( i )-th IZ.
-   ( $N_i$ ) is the total number of pre-school children in the same IZ.
-   ( $p_i$ ) represents the proportion of susceptible children.

We aim to test whether the **proportion of susceptible children changed significantly after 2004**. We formulate two statistical models:

#### **1. Comparison of Two Proportions (Chi-square Test)**

To compare **pre-2004 vs. post-2004**, we define the null and alternative hypotheses:

$$
H_0: p_{\text{pre}} = p_{\text{post}}
$$

$$
H_A: p_{\text{pre}} \neq p_{\text{post}}
$$

where:

-   ( $p_\text{pre}$ ) is the overall proportion of susceptible children in **1998, 2000, and 2002**.
-   ( $p_\text{post}$ ) is the overall proportion in **2004, 2008, 2010, and 2012**.

We use a **chi-square test for independence** on the contingency table,the p-value 0.7434 suggests that there is no statistically significant difference in the proportion of susceptible children between pre-2004 and post-2004.

```{r}
#| echo: false
#| message: false
#| warning: false
#| tbl-placement: "H"
#| tbl-cap: chi-square test for independence
data_pre <- data1 %>% filter(Year < 2004)
data_post <- data1 %>% filter(Year >= 2004)
Y_pre <- sum(data_pre$Y)
N_pre <- sum(data_pre$N)
Y_post <- sum(data_post$Y)
N_post <- sum(data_post$N)
contingency_table <- matrix(c(Y_pre, N_pre - Y_pre, Y_post, N_post - Y_post), nrow=2, byrow=TRUE)
colnames(contingency_table) <- c("Susceptible", "Not Susceptible")
rownames(contingency_table) <- c("Pre-2004", "Post-2004")
chi_test <- chisq.test(contingency_table)
library(sjPlot)
tab_df(tidy(chi_test), title = "Chi-square Test for Independence")
```

\(b\)
```{r}
data <- read.csv("DAProject15.csv")
data <- na.omit(data[,c("Year","N","Y")])
data$Year_c <- data$Year-1998

data$seg1 <- ifelse(data$Year<2004,data$Year_c,0)
data$seg2 <- ifelse(data$Year >= 2004 & data$Year < 2010, data$Year_c - 6, 0)
data$seg3 <- ifelse(data$Year>=2010, data$Year_c-12,0)

data$ID <- rep(1:133,times=length(unique(data$Year)))

data$I2004 <- as.numeric(data$Year >= 2004)
data$I2010 <- as.numeric(data$Year >= 2010)
```

Following the initial chi-square test and exploratory analysis, we proceed with a more detailed statistical investigation by fitting a generalized linear mixed model (GLMM) with a binomial family and a logit link function to model changes in measles susceptibility among preschool children in Glasgow between 1998 and 2012.Let:

-   $Y_{it}$: the number of susceptible children in intermediate zone $i$ at year $t$

-   $N_{it}$: total number of children in the same group

-   $p_{it}$: probability that a child in zone $i$ at time $t$ is susceptible to measles

Then the model assumes: $$
Y_{it}\sim Binomial(N_{it},p_{it})
$$ and the logit of the probability is modeled as: $$
logit(p_{it})=\beta_0+\beta_1\cdot seg1_{it}+\beta_2\cdot seg2_{it}+\beta_3\cdot seg3_{it}+\beta_4\cdot I2004_{it}+\beta_5\cdot I2010_{it}+(1|IZ)
$$ where:

-   $\beta_0$ is the global intercept, representing the baseline log-odds of susceptibility in the reference group .

-   $\beta_1,\beta_2,\beta_3$ are the slopes for different time segments (gradual trends)

-   $\beta_4,\beta_5$ capture abrupt level shifts in 2004 and 2010 respectively

-   $seg1,seg2,seg3$ capture linear time trends within three periods: 1998–2003, 2004–2009, and 2010–2012, allowing different slopes for each segment.

-   $I2004,I2010$ are binary indicators for years ≥ 2004 and ≥ 2010, respectively, capturing abrupt level shifts in susceptibility associated with the partial (2004) and full (2010) retraction of the Wakefield article.

-   $(1|IZ)$ A random intercept term allowing each intermediate zone to have its own baseline level of susceptibility.

```{r}
model_full <- glmer(
  cbind(Y,N-Y)~seg1+seg2+seg3+I2004+I2010+(1|ID),
  data=data,
  family = binomial
)

```

@tbl-model_full presents the fixed effects estimates from the GLMM. The intercept of –3.025 represents the baseline log-odds of measles susceptibility in 1998. The coefficients for the segmented time trends indicate a significant increase at 1% significance level during 1998–2003 ($seg1:$β=0.107, p\<0.001) and continued growth in 2004–2009 ($seg2:$β=0.112, p\<0.001), followed by a significant decline at 5% significance level from 2010–2012 ($seg3:$β=–0.058, p\<0.05), suggesting improved vaccination uptake in later years.

The jump terms are also statistically significant. An upward shift in 2004 (β=0.32, p\<0.001) aligns with the partial retraction of the Wakefield article, while a notable drop in 2010 (β=–0.260, p\<0.001) coincides with the article’s full discrediting, indicating a public recovery in vaccine confidence.

Model fit is strong, with Marginal$R²$=0.18 and Conditional$R²$=0.853, demonstrating that both fixed effects and random effects substantially explain the variation in susceptibility across time and space.

```{r}
#| echo: false
#| label: tbl-model_full
#| tbl-cap: Summary of coefficients in model full
#| tbl-placement: "H"
fixed_effects <- broom.mixed::tidy(model_full, effects="fixed")
fixed_effects <- fixed_effects[, c("term", "estimate", "std.error", "statistic", "p.value")]

fixed_effects$p.value <- format.pval(fixed_effects$p.value, digits = 4, eps = 1e-6)

r2_values <- performance::r2(model_full)
r2_note <- paste0("Marginal R² = ", round(r2_values$R2_marginal, 3),
                  "; Conditional R² = ", round(r2_values$R2_conditional, 3))

kable(fixed_effects, digits = 3, caption = "Fixed Effects Summary of Full Model",
      booktabs = TRUE, linesep = "") %>%
  kable_styling(latex_options = c("striped", "hold_position", "threeparttable")) %>%
  add_header_above(c(" " = 1, "Fixed Effect Estimates" = 4)) %>%
  footnote(general = r2_note)
```

To identify the most appropriate model for explaining measles susceptibility in Glasgow, several candidate models were fitted:

-   Model 1: Null model (random intercept only)

The logit of the probability is modeled as: $$
\text{logit}(p_{it}) = \beta_0 + b_i
$$ where $$ b_i \sim \mathcal{N}(0, \sigma^2) $$ is a random intercept for intermediate zone $i$.

-   Model 2: Segmented time trends only (no random effects) $$
    \text{logit}(p_{it}) = \beta_0 + \beta_1 \cdot \text{seg1}_{it} + \beta_2 \cdot \text{seg2}_{it} + \beta_3 \cdot \text{seg3}_{it}
    $$

-   Model 3: Segmented trends with random intercepts $$
    \text{logit}(p_{it}) = \beta_0 + \beta_1 \cdot \text{seg1}_{it} + \beta_2 \cdot \text{seg2}_{it} + \beta_3 \cdot \text{seg3}_{it} + b_i
    $$

And we compared them using AIC, BIC, and $R^2$, as the @tbl-comparison shows, the fill model which included both segmented trends and binary indicators achieved the lowest AIC(4504.93)/BIC(4538.78) and highest marginal(0.18) and confitional(0.853) $R^2$, indicating it best captures both temporal changes and spatial variation in susceptibility. This model was therefore selected for detailed interpretation.

```{r}
Model_null <- glmer(cbind(Y,N-Y)~1+(1|ID), data = data, family = binomial)

Model_trend <- glm(cbind(Y,N-Y)~seg1+seg2+seg3, data = data, family = binomial)

Model_trend_ID <- glmer(cbind(Y,N-Y)~seg1+seg2+seg3+(1|ID), data = data, family = binomial)

model_list <- list(Model_null=Model_null,Model_trend=Model_trend,Model_trend_ID=Model_trend_ID,model_full=model_full)
AIC_values <- sapply(model_list, AIC)
BIC_values <- sapply(model_list, BIC)
get_r2 <- function(m) {
  if ("glmerMod" %in% class(m)) {
    r2 <- performance::r2(m)
    return(c(r2$R2_marginal, r2$R2_conditional))
  } else {
    return(c(NA, NA))  
  }
}
r2_matrix <- t(sapply(model_list, get_r2))
```

```{r}
#| echo: false
#| label: tbl-comparison
#| tbl-cap: Model comparison table
#| tbl-placement: "H"
attach(data)
#| echo: false
tmp <- capture.output(
  m2_r2 <- pscl::pR2(update(Model_trend, data = data))["McFadden"]
)
r2_matrix["Model_trend", 1] <- round(as.numeric(tmp), 3)  
r2_matrix["Model_trend", 2] <- NA                          

comparison_table <- data.frame(
  Model=names(model_list),
  AIC=round(AIC_values,2),
  BIC=round(BIC_values,2),
  Marginal_R2=round(r2_matrix[,1],3),
  Conditonal_R2=round(r2_matrix[,2],3)
)
knitr::kable(comparison_table,caption = "Model Comparison using AIC, BIC, and R-square")%>%
  kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

@fig-line compares the actual and predicted proportions of measles-susceptible children in Glasgow from 1998–2012. The actual trend (blue) closely follows the full model’s predictions (red dashed), indicating a good fit.

Susceptibility increased between 1998 and 2003, rose further after 2004, and declined sharply around 2010. These abrupt changes correspond to the full retractions of the Wakefield article, which are effectively captured by the model’s jump terms (I2010).

```{r}
#| echo: false
#| label: fig-line
#| fig-cap: Actual vs Predicted Measles Susceptibility Rate
#| fig-pos: "H"
data_summary <- data %>%
  group_by(Year) %>%
  summarise(actual_rate=sum(Y)/sum(N))
data$predicted_logit <- predict(model_full, type = "link")
data$predicted_prob <- predict(model_full, type = "response")

predicted_summary <- data %>%
  group_by(Year) %>%
  summarise(predicted_rate = mean(predicted_prob))

plot_data <- left_join(data_summary, predicted_summary, by = "Year")

ggplot(plot_data, aes(x = Year)) +
  geom_line(aes(y = actual_rate), color = "blue", size = 1.2) +
  geom_line(aes(y = predicted_rate), color = "red", size = 1.2, linetype = "dashed") +
  labs(title = "Actual vs Predicted Measles Susceptibility Rate",
       y = "Proportion Susceptible",
       caption = "Blue = Actual, Red Dashed = Predicted from model_full") +
  theme_minimal()
```

Overall, this visual and statistical evidence strongly supports both project hypotheses. Glasgow experienced a significant change in measles susceptibility following the retraction of the Wakefield article. While the immediate effect in 2004 was an upward shift in susceptibility, a more substantial decline occurred around 2010, reflecting a delayed yet important recovery in public vaccine confidence.
